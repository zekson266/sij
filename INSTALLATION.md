# Installation Guide

Quick start guide for setting up the Booker application from scratch.

## Prerequisites

- **Docker** and **Docker Compose** installed
- **Domain name** (for SSL certificates) or use `localhost` for development
- **Python 3.11+** (for install script)
- **Root/sudo access** (for SSL certificate generation)

## Quick Start

### 1. Clone the Repository

```bash
git clone <repository-url>
cd booker
```

### 2. Run Installation Script

The install script will:
- Generate SSL certificates (standard or wildcard)
- Create `.env` file with all configuration
- Generate secure keys (SECRET_KEY, ENCRYPTION_KEY, database passwords)
- Set up PostgreSQL with SSL
- Create database user

```bash
./install.sh
```

**SSL Certificate Options:**
- **Option 1 (Standard SSL)**: Covers `yourdomain.com` and `www.yourdomain.com` only - Fully automatic via HTTP challenge
- **Option 2 (Wildcard SSL - Recommended)**: Covers `*.yourdomain.com` and `yourdomain.com` (all subdomains) - **Required for multi-tenant subdomain feature** - Interactive, requires DNS TXT record
- **Option 3**: Skip SSL setup (configure manually later)

**For multi-tenant applications using tenant subdomains, choose Option 2 (Wildcard SSL).**

**Wildcard SSL Setup (Option 2):**
1. Select option 2 during installation
2. Certbot will display a DNS TXT record to add
3. Log into your DNS provider (Cloudflare, Namecheap, etc.)
4. Add the TXT record as instructed
5. Wait 1-5 minutes for DNS propagation
6. Press Enter in the installer to continue
7. Certbot will verify and issue the wildcard certificate

### 3. Start Services

```bash
docker compose up -d
```

This starts:
- PostgreSQL database (with SSL)
- FastAPI backend
- Frontend build (installs dependencies including Material UI and React Router)
- Nginx (after frontend is built)

### 4. Run Database Migrations

This project uses a **single initial migration** (`001_initial_complete_schema.py`) that creates all 15 tables from scratch. This ensures clean fresh installs with no missing tables.

```bash
docker compose exec backend alembic upgrade head
```

**What this creates:**
- Core tables: `users`, `tenants`, `tenant_users`, `verification_tokens`, `oauth_accounts`
- Booker module: `appointments`
- ROPA module: `ropa_repositories`, `ropa_activities`, `ropa_data_elements`, `ropa_departments`, `ropa_dpias`, `ropa_locations`, `ropa_risks`, `ropa_systems`
- AI support: `ai_suggestion_jobs`

All tables are created in one step.

### 5. Build Frontend

The frontend build automatically installs all dependencies including:
- **Material UI** (@mui/material) - UI component library
- **React Router** (react-router) - Client-side routing
- **Roboto Font** (@fontsource/roboto) - Material Design typography
- **Material Icons** (@mui/icons-material) - Icon library

```bash
docker compose up frontend-build
```

**Note:** All frontend dependencies are automatically installed during the build process. No manual installation needed.

### 6. Verify Installation

Check health endpoint:
```bash
curl http://localhost/api/health
```

Or visit: `http://localhost/api/docs` for API documentation

---

## Optional: Initial Setup

Create an initial admin user and tenant:

### 1. Edit `.env` file

Add these lines:
```bash
INITIAL_ADMIN_EMAIL=admin@example.com
INITIAL_ADMIN_PASSWORD=SecurePassword123
INITIAL_TENANT_NAME=My Company
INITIAL_TENANT_EMAIL=admin@example.com
```

### 2. Run Setup Script

```bash
docker compose exec backend python scripts/initial_setup.py
```

This creates:
- Admin user (with superuser privileges)
- Initial tenant
- Adds admin as owner of the tenant

**Important**: Change the admin password after first login!

---

## Configuration

All configuration is in `.env` file. Key settings:

### Required (Auto-generated by install.sh)
- `SECRET_KEY` - JWT signing key
- `POSTGRES_PASSWORD` - Database password
- `DOMAIN_NAME` - Your domain

### Optional
- `DEBUG=1` - Enable debug mode
- `SMTP_ENABLED=1` - Enable email sending
- `SMTP_USER`, `SMTP_PASSWORD` - Email credentials
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` - Google OAuth credentials
- `ACCESS_TOKEN_EXPIRE_MINUTES=30` - Token expiration

See `.env` file for all available options.

---

## Email Configuration (Optional)

To enable email sending for verification and password reset:

1. Edit `.env`:
```bash
SMTP_ENABLED=1
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM_EMAIL=noreply@yourdomain.com
SMTP_FROM_NAME=Booker
SMTP_USE_TLS=1
```

2. Restart backend:
```bash
docker compose restart backend
```

---

## Google OAuth Configuration (Optional)

To enable "Sign in with Google" functionality:

### 1. Create Google OAuth Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing one
3. Enable Google+ API
4. Go to **Credentials** → **Create Credentials** → **OAuth 2.0 Client ID**
5. Configure OAuth consent screen (required first time)
6. Application type: **Web application**
7. Add authorized redirect URIs:
   - `https://yourdomain.com`
   - `https://www.yourdomain.com`
8. Copy the **Client ID** and **Client Secret**

### 2. Configure Backend

Edit `/root/funapp/.env`:
```bash
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
```

### 3. Configure Frontend

Edit `/root/funapp/frontend/.env`:
```bash
VITE_GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
```

### 4. Rebuild and Restart

```bash
# Rebuild frontend with Google OAuth
./scripts/build-frontend.sh

# Restart services
docker compose restart backend nginx
```

**Features:**
- Auto-linking: If user exists with same email, Google account automatically links
- OAuth-only users: Users can sign in with Google without setting a password
- HttpOnly cookies: Same secure authentication as email/password login

---

## Troubleshooting

### Port Already in Use
If port 80/443 is already in use:
- Stop other web servers
- Or modify `docker-compose.yml` to use different ports

### Database Connection Failed
- Check `.env` has correct `POSTGRES_PASSWORD`
- Ensure database container is running: `docker compose ps`
- Check logs: `docker compose logs db`

### SSL Certificate Issues

**Standard SSL (Option 1):**
- Re-run install script: `./install.sh`
- Or manually: `certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com`

**Wildcard SSL (Option 2):**
- Re-run install script: `./install.sh` and choose option 2
- Or manually: `certbot certonly --manual --preferred-challenges dns -d yourdomain.com -d *.yourdomain.com`
- Follow DNS TXT record instructions from certbot

**Tenant Subdomains Show SSL Warnings:**
- You need a wildcard certificate (Option 2)
- Standard certificates (Option 1) only cover the main domain and www subdomain
- Generate wildcard certificate and restart nginx: `docker compose restart nginx`

### Migration Errors
- Check database is running: `docker compose ps db`
- View migration status: `docker compose exec backend alembic current`
- Check logs: `docker compose logs backend`

---

## Development Mode

For development without SSL:

1. Set in `.env`:
```bash
DOMAIN_NAME=localhost
DEBUG=1
```

2. Access API at: `http://localhost:8000/api/docs`

---

## Production Deployment

1. **Set strong passwords** in `.env`:
   - `SECRET_KEY` (min 32 characters)
   - `POSTGRES_PASSWORD`
   - `SMTP_PASSWORD` (if using email)

2. **Disable debug mode**:
```bash
DEBUG=0
```

3. **Enable email sending** (see Email Configuration above)

4. **Set up SSL certificates** (done by install.sh)

5. **Configure firewall**:
   - Allow ports 80 (HTTP) and 443 (HTTPS)
   - Block direct database access (port 5432)

6. **Set up backups** for PostgreSQL

---

## API Endpoints

Once running, access:

- **API Documentation**: `http://localhost/api/docs`
- **Health Check**: `http://localhost/api/health`
- **Test Optional Auth**: `http://localhost/api/test-optional-auth`

### Authentication
- `POST /api/auth/register` - User registration
- `POST /api/auth/login` - User login (supports optional tenant_id query param)
- `POST /api/auth/refresh` - Refresh token (supports tenant context switching)
- `POST /api/auth/verify-email` - Verify email
- `POST /api/auth/forgot-password` - Request password reset
- `POST /api/auth/reset-password` - Reset password
- `GET /api/auth/me` - Get current user (requires auth)
- `GET /api/auth/tenants` - Get user's tenants (requires auth)

### Tenants
- `POST /api/tenants` - Create tenant (**requires auth**, creator becomes owner)
- `GET /api/tenants` - List tenants (public)
- `GET /api/tenants/{tenant_id}` - Get tenant by ID (public)
- `GET /api/tenants/slug/{slug}` - Get tenant by slug (public)
- `GET /api/tenants/slug/{slug}/public` - Public tenant info with optional auth enhancement (public, enhanced if authenticated)
- `PATCH /api/tenants/{tenant_id}` - Update tenant (**requires auth + admin/owner role**)
- `DELETE /api/tenants/{tenant_id}` - Delete tenant (**requires auth + owner role only**)

### Tenant Members
- `POST /api/tenants/{tenant_id}/members` - Invite user (requires auth + admin/owner)
- `GET /api/tenants/{tenant_id}/members` - List members (requires auth + tenant membership)
- `PATCH /api/tenants/{tenant_id}/members/{user_id}` - Update member (requires auth + admin/owner)
- `DELETE /api/tenants/{tenant_id}/members/{user_id}` - Remove member (requires auth + admin/owner)

---

## Architecture Features

### Public-First Design
The application supports a public-first architecture:
- **Public Pages**: Work without authentication
- **Optional Authentication**: Endpoints can work with or without auth
- **Progressive Enhancement**: More features for authenticated users
- **Conditional UI**: Frontend can show different content based on auth state

### Security Improvements
Recent security enhancements:
- ✅ Tenant creation requires authentication
- ✅ Tenant updates require admin/owner role
- ✅ Tenant deletion requires owner role only
- ✅ Creator automatically becomes owner when creating tenant
- ✅ Role-based access control properly enforced

## Next Steps

1. **Create your first user**: `POST /api/auth/register`
2. **Login**: `POST /api/auth/login`
3. **Create a tenant**: `POST /api/tenants` (requires auth, you become owner)
4. **View public tenant info**: `GET /api/tenants/slug/{slug}/public` (works without auth)
5. **Invite users**: `POST /api/tenants/{tenant_id}/members` (requires auth + admin/owner)

See `ARCHITECTURE.md` for detailed architecture documentation.

---

## Support

- **Architecture Docs**: See `ARCHITECTURE.md`
- **Code Documentation**: See code docstrings
- **API Docs**: Visit `/api/docs` when running

